const similarityMatrixStringified1 = "[\"NMD_R1 W\", [1.0, 0.8458868534842395, 0.8318886292266292, 0.8335455407406163, 0.8743813293430519, 0.7981486030541015, 0.8983542182284354, 0.7813462783875235, 0.7890849954224303, 0.873457615952871], \"PW HUMAN RACE NMD\", [0.8458868534842395, 1.0, 0.8481005401239688, 0.7211241115489215, 0.8760192557988494, 0.7155867059153892, 0.8602118411344233, 0.7303351296106229, 0.7408559060721788, 0.7911474628744284], \"NMD_R1 PK\", [0.8318886292266292, 0.8481005401239688, 1.0, 0.7308953825092931, 0.8575498760122623, 0.7142105907452109, 0.8106519927648874, 0.7833309329111797, 0.7733735511216898, 0.807280889332601], \"NMD_C1 TR\", [0.8335455407406163, 0.7211241115489215, 0.7308953825092931, 1.0, 0.7662220155189163, 0.8162666735754373, 0.8314098142490741, 0.8105136935019615, 0.7948713635829422, 0.8385296232051517], \"NMD_R:\", [0.8743813293430519, 0.8760192557988494, 0.8575498760122623, 0.7662220155189163, 1.0, 0.7834403114588049, 0.8882113675947549, 0.7689527757613212, 0.8021748402260007, 0.8502661420710097], \"NMD RUNNER PK\", [0.7981486030541015, 0.7155867059153892, 0.7142105907452109, 0.8162666735754373, 0.7834403114588049, 1.0, 0.8237893350354358, 0.8057681160284992, 0.8368814545644675, 0.818165030581757], \"NMD_CS1 PK\", [0.8983542182284354, 0.8602118411344233, 0.8106519927648874, 0.8314098142490741, 0.8882113675947549, 0.8237893350354358, 1.0, 0.7722150042210533, 0.7714742963411894, 0.8829932417138877], \"NMD_R1 J\", [0.7813462783875235, 0.7303351296106229, 0.7833309329111797, 0.8105136935019615, 0.7689527757613212, 0.8057681160284992, 0.7722150042210533, 1.0, 0.8473256695659126, 0.7651360893606535], \"NMD_R1 TRAIL W\", [0.7890849954224303, 0.7408559060721788, 0.7733735511216898, 0.7948713635829422, 0.8021748402260007, 0.8368814545644675, 0.7714742963411894, 0.8473256695659126, 1.0, 0.7589895645947367], \"NMD_XR1 PK\", [0.873457615952871, 0.7911474628744284, 0.807280889332601, 0.8385296232051517, 0.8502661420710097, 0.818165030581757, 0.8829932417138877, 0.7651360893606535, 0.7589895645947367, 1.0]]";
const similarityMatrixStringified2 = "{\"YUNG SERIES\":[1.0,0.8398597535,0.8365875682,0.8042827469,0.8992397112,0.876487497,0.7362240209,0.8067106669,0.6984964657,0.8672050349,0.8957857537,0.8818672959,0.8775830921,0.6115907652,0.3800785176,0.8771236248,0.8442490538,0.7451491204,0.9024660091,0.7533307578,0.7910764799,0.7672355654,0.7929765811,0.8995830809,0.8406111415,0.8025576134,0.747802079,0.7283552073,0.8430590008], \"not applicable\":[0.8398597535,1.0,0.7916337144,0.7906635768,0.8993792043,0.8576248146,0.7903731726,0.7837620048,0.6402277965,0.8544448547,0.9204342739,0.85884988,0.8588323918,0.5904814859,0.333328241,0.8367904192,0.8609602384,0.6936587562,0.8569385462,0.795390044,0.7770531432,0.7717323756,0.7485519216,0.8995832564,0.8074197381,0.8353142521,0.7379833405,0.6584030349,0.8488957336], \"NMD\":[0.8365875682,0.7916337144,1.0,0.87264013,0.8930579904,0.8931369735,0.806309904,0.8661765153,0.7969623461,0.879576783,0.8688231011,0.8687823112,0.8672891863,0.5762437026,0.4105884141,0.7861262814,0.8220059533,0.6418882095,0.8888476057,0.7947467189,0.8719591283,0.8329088244,0.8109435512,0.8224278287,0.8629779949,0.8200146616,0.7650762948,0.7782820165,0.8517760885],\"ZX\":[0.8042827469,0.7906635768,0.87264013,1.0,0.8795983344,0.8839130382,0.8492045745,0.8230708161,0.8321837773,0.8620748218,0.8564848895,0.839215821,0.8304226748,0.5816006742,0.4159092869,0.7511331948,0.784824682,0.6085806057,0.8708907533,0.7843419496,0.8236543732,0.8191663947,0.8176655548,0.8009970519,0.8319744095,0.8063716035,0.726135682,0.7869801217,0.8303958074],\"Stan Smith\":[0.8992397112,0.8993792043,0.8930579904,0.8795983344,1.0,0.9440495559,0.8521875979,0.8638868554,0.7632562108,0.9226942175,0.9515319289,0.9237950679,0.9183979681,0.6195541247,0.3998347279,0.8672829029,0.8813436559,0.7129121499,0.9441023664,0.8183283732,0.8478762854,0.8334539958,0.8407777818,0.9172472403,0.8863052902,0.8622223985,0.7794308103,0.7896596038,0.9077991808],\"Ultra Boost\":[0.876487497,0.8576248146,0.8931369735,0.8839130382,0.9440495559,1.0,0.8696739288,0.8616460521,0.7792970984,0.9131378703,0.9183327521,0.905229686,0.8937360086,0.6116290399,0.4188632126,0.8277727221,0.8436621176,0.6787841101,0.9389318912,0.8094777348,0.8588574015,0.8411043921,0.8494949404,0.8732243989,0.892352831,0.8356723596,0.7655000717,0.8286054581,0.8952530097],\"I-5923\":[0.7362240209,0.7903731726,0.806309904,0.8492045745,0.8521875979,0.8696739288,1.0,0.7494727095,0.7371663676,0.8196575632,0.8260248553,0.7892255326,0.7794882618,0.5589774439,0.3716483697,0.6858074892,0.760977209,0.5630432215,0.8184012907,0.78617971,0.784284197,0.7990383149,0.7699492074,0.7601609531,0.7845955288,0.807351316,0.6742365945,0.7432115385,0.8102304893],\"SWIFT\":[0.8067106669,0.7837620048,0.8661765153,0.8230708161,0.8638868554,0.8616460521,0.7494727095,1.0,0.7453484105,0.8648811565,0.8451414065,0.8504902124,0.8385156984,0.5512889831,0.3736721072,0.7836334966,0.7997450641,0.6422247664,0.8509516277,0.7536684488,0.8046107883,0.7714074732,0.7563925701,0.8097177929,0.8188523862,0.7877990033,0.7506612635,0.7406212456,0.8210994375],\"Predator\":[0.6984964657,0.6402277965,0.7969623461,0.8321837773,0.7632562108,0.7792970984,0.7371663676,0.7453484105,1.0,0.7669970545,0.7277020745,0.7323067611,0.7109160152,0.474310846,0.4067794785,0.6459703448,0.6352486829,0.524340385,0.7919185944,0.6734296353,0.7433800205,0.7295312941,0.7378918602,0.6812498925,0.7337181644,0.6802837796,0.6463478529,0.7748371924,0.7252557518],\"EQT ADV\":[0.8672050349,0.8544448547,0.879576783,0.8620748218,0.9226942175,0.9131378703,0.8196575632,0.8648811565,0.7669970545,1.0,0.9108892689,0.9124015765,0.8746060754,0.5790009075,0.3782623245,0.8676258651,0.845872585,0.7184715697,0.9127517226,0.7797314292,0.8205594699,0.7927260366,0.8174627707,0.8983552764,0.8554976604,0.8309920794,0.8173879771,0.7789710171,0.8706684852],\"ALPHABOUNCE\":[0.8957857537,0.9204342739,0.8688231011,0.8564848895,0.9515319289,0.9183327521,0.8260248553,0.8451414065,0.7277020745,0.9108892689,1.0,0.9236994061,0.9152685449,0.6177902698,0.3818348781,0.8809041849,0.8988909012,0.7317853746,0.9163284532,0.8237042962,0.8382033779,0.8257681035,0.8103448866,0.9360470107,0.8674464502,0.8756437023,0.790114777,0.7359558367,0.9130267649],\"P.O.D.SYSTEM\":[0.8818672959,0.85884988,0.8687823112,0.839215821,0.9237950679,0.905229686,0.7892255326,0.8504902124,0.7323067611,0.9124015765,0.9236994061,1.0,0.8935932341,0.599839126,0.3798041066,0.8784704937,0.8603586672,0.7431341405,0.904469542,0.778607501,0.8067340145,0.7854516078,0.8066659915,0.9034059167,0.8592191388,0.8336648729,0.8077660038,0.7454640308,0.8748467057],\"DEERUPT\":[0.8775830921,0.8588323918,0.8672891863,0.8304226748,0.9183979681,0.8937360086,0.7794882618,0.8385156984,0.7109160152,0.8746060754,0.9152685449,0.8935932341,1.0,0.5899078364,0.3811749152,0.8376681948,0.8661382449,0.685919289,0.8862805272,0.7838867464,0.8033235962,0.7889855207,0.7997526187,0.8745057489,0.8462204049,0.844479852,0.7617162123,0.7187078269,0.8781749218],\"Pure Boost\":[0.6115907652,0.5904814859,0.5762437026,0.5816006742,0.6195541247,0.6116290399,0.5589774439,0.5512889831,0.474310846,0.5790009075,0.6177902698,0.599839126,0.5899078364,1.0,0.2769769785,0.5853743109,0.6166448594,0.5085787346,0.5946320751,0.5783976521,0.5902586417,0.5969258626,0.5317893832,0.6162830623,0.5787418513,0.5764344983,0.4934025842,0.4918265609,0.5847797193],\"PROPHERE\":[0.3800785176,0.333328241,0.4105884141,0.4159092869,0.3998347279,0.4188632126,0.3716483697,0.3736721072,0.4067794785,0.3782623245,0.3818348781,0.3798041066,0.3811749152,0.2769769785,1.0,0.3299793592,0.349682712,0.2735924216,0.4162072337,0.3447573773,0.3879646036,0.3749253771,0.3860400715,0.3500387498,0.3695535416,0.3479569336,0.3260189804,0.397036504,0.3915364295],\"Tubular\":[0.8771236248,0.8367904192,0.7861262814,0.7511331948,0.8672829029,0.8277727221,0.6858074892,0.7836334966,0.6459703448,0.8676258651,0.8809041849,0.8784704937,0.8376681948,0.5853743109,0.3299793592,1.0,0.8328439899,0.8069878619,0.8667861681,0.7205480753,0.752389954,0.7256217735,0.7362540182,0.9204131953,0.8040840794,0.7757390731,0.7732405804,0.6677767774,0.8120739217],\"FALCON\":[0.8442490538,0.8609602384,0.8220059533,0.784824682,0.8813436559,0.8436621176,0.760977209,0.7997450641,0.6352486829,0.845872585,0.8988909012,0.8603586672,0.8661382449,0.6166448594,0.349682712,0.8328439899,1.0,0.7131606425,0.8231499363,0.8266433961,0.7938768081,0.7872102751,0.7311402644,0.8822301063,0.7954222475,0.8473564311,0.7466396263,0.6290429651,0.8477309816],\"Campus\":[0.7451491204,0.6936587562,0.6418882095,0.6085806057,0.7129121499,0.6787841101,0.5630432215,0.6422247664,0.524340385,0.7184715697,0.7317853746,0.7431341405,0.685919289,0.5085787346,0.2735924216,0.8069878619,0.7131606425,1.0,0.7037921324,0.6259804999,0.6266390613,0.6168654443,0.5776064486,0.8209770125,0.648108329,0.6527591788,0.6754974275,0.5187223402,0.6715224827],\"CONTINENTAL 80\":[0.9024660091,0.8569385462,0.8888476057,0.8708907533,0.9441023664,0.9389318912,0.8184012907,0.8509516277,0.7919185944,0.9127517226,0.9163284532,0.904469542,0.8862805272,0.5946320751,0.4162072337,0.8667861681,0.8231499363,0.7037921324,1.0,0.7734945965,0.8396160092,0.8045842469,0.8589250365,0.8927680743,0.8918815244,0.8095957716,0.7554185902,0.843467296,0.8754376881],\"SOBAKOV\":[0.7533307578,0.795390044,0.7947467189,0.7843419496,0.8183283732,0.8094777348,0.78617971,0.7536684488,0.6734296353,0.7797314292,0.8237042962,0.778607501,0.7838867464,0.5783976521,0.3447573773,0.7205480753,0.8266433961,0.6259804999,0.7734945965,1.0,0.7989710256,0.8083671984,0.6874006335,0.7883993687,0.7651333571,0.7971763923,0.6753689991,0.6395776341,0.7823854122],\"FOREST GROVE\":[0.7910764799,0.7770531432,0.8719591283,0.8236543732,0.8478762854,0.8588574015,0.784284197,0.8046107883,0.7433800205,0.8205594699,0.8382033779,0.8067340145,0.8033235962,0.5902586417,0.3879646036,0.752389954,0.7938768081,0.6266390613,0.8396160092,0.7989710256,1.0,0.8500013257,0.7498601811,0.8032081498,0.8224294896,0.7848977869,0.701973213,0.7430065414,0.8156448638],\"Gazelle\":[0.7672355654,0.7717323756,0.8329088244,0.8191663947,0.8334539958,0.8411043921,0.7990383149,0.7714074732,0.7295312941,0.7927260366,0.8257681035,0.7854516078,0.7889855207,0.5969258626,0.3749253771,0.7256217735,0.7872102751,0.6168654443,0.8045842469,0.8083671984,0.8500013257,1.0,0.7247851134,0.7908427133,0.7980739666,0.7838902577,0.6805305722,0.7168126316,0.806075523],\"Powerlift\":[0.7929765811,0.7485519216,0.8109435512,0.8176655548,0.8407777818,0.8494949404,0.7699492074,0.7563925701,0.7378918602,0.8174627707,0.8103448866,0.8066659915,0.7997526187,0.5317893832,0.3860400715,0.7362540182,0.7311402644,0.5776064486,0.8589250365,0.6874006335,0.7498601811,0.7247851134,1.0,0.7626638974,0.7998384319,0.7299347331,0.6753077226,0.7659168843,0.785145329],\"ZX Flux\":[0.8995830809,0.8995832564,0.8224278287,0.8009970519,0.9172472403,0.8732243989,0.7601609531,0.8097177929,0.6812498925,0.8983552764,0.9360470107,0.9034059167,0.8745057489,0.6162830623,0.3500387498,0.9204131953,0.8822301063,0.8209770125,0.8927680743,0.7883993687,0.8032081498,0.7908427133,0.7626638974,1.0,0.8332024344,0.835025961,0.7935575984,0.7046335285,0.876203048],\"Samba\":[0.8406111415,0.8074197381,0.8629779949,0.8319744095,0.8863052902,0.892352831,0.7845955288,0.8188523862,0.7337181644,0.8554976604,0.8674464502,0.8592191388,0.8462204049,0.5787418513,0.3695535416,0.8040840794,0.7954222475,0.648108329,0.8918815244,0.7651333571,0.8224294896,0.7980739666,0.7998384319,0.8332024344,1.0,0.7847014894,0.7185376058,0.7659655637,0.8313480829],\"Superstar\":[0.8025576134,0.8353142521,0.8200146616,0.8063716035,0.8622223985,0.8356723596,0.807351316,0.7877990033,0.6802837796,0.8309920794,0.8756437023,0.8336648729,0.844479852,0.5764344983,0.3479569336,0.7757390731,0.8473564311,0.6527591788,0.8095957716,0.7971763923,0.7848977869,0.7838902577,0.7299347331,0.835025961,0.7847014894,1.0,0.7626351618,0.643496872,0.8416947154],\"X_PLR\":[0.747802079,0.7379833405,0.7650762948,0.726135682,0.7794308103,0.7655000717,0.6742365945,0.7506612635,0.6463478529,0.8173879771,0.790114777,0.8077660038,0.7617162123,0.4934025842,0.3260189804,0.7732405804,0.7466396263,0.6754974275,0.7554185902,0.6753689991,0.701973213,0.6805305722,0.6753077226,0.7935575984,0.7185376058,0.7626351618,1.0,0.6585987255,0.7674275577],\"SOLAR BOOST\":[0.7283552073,0.6584030349,0.7782820165,0.7869801217,0.7896596038,0.8286054581,0.7432115385,0.7406212456,0.7748371924,0.7789710171,0.7359558367,0.7454640308,0.7187078269,0.4918265609,0.397036504,0.6677767774,0.6290429651,0.5187223402,0.843467296,0.6395776341,0.7430065414,0.7168126316,0.7659168843,0.7046335285,0.7659655637,0.643496872,0.6585987255,1.0,0.7420129071],\"ARKYN\":[0.8430590008,0.8488957336,0.8517760885,0.8303958074,0.9077991808,0.8952530097,0.8102304893,0.8210994375,0.7252557518,0.8706684852,0.9130267649,0.8748467057,0.8781749218,0.5847797193,0.3915364295,0.8120739217,0.8477309816,0.6715224827,0.8754376881,0.7823854122,0.8156448638,0.806075523,0.785145329,0.876203048,0.8313480829,0.8416947154,0.7674275577,0.7420129071,1.0]}";
const similarityMatrix1 = JSON.parse(similarityMatrixStringified1);

// Map second similarity matrix to expected data structure
const similarityMatrix2Raw = JSON.parse(similarityMatrixStringified2);
const similarityMatrix2 = [];
Object.keys(similarityMatrix2Raw).forEach((key, index) => {
    similarityMatrix2[index * 2] = key;
    similarityMatrix2[index * 2 + 1] = similarityMatrix2Raw[key];
});

let similarityThreshold = 0.9;

const similarityMatrix = similarityMatrix2;

let nodes = [];
let edges = [];

let products = [];

let sliderBounceBackTimeout = null;

function init() {

    const container = document.getElementById("product-similarity-map");
    const similarityDisplay = document.getElementById("similarity-display");
    similarityDisplay.innerText = `>=${similarityThreshold * 100}%`;

    for (let i = 0; i < similarityMatrix.length; i += 2) {
        products.push(similarityMatrix[i]);
    }

    products.forEach((productLabel, index) => {
        nodes.push({
            id: index,
            label: productLabel,
            title: productLabel,
            image: `./images/${productLabel.toUpperCase().replace(/ /g, "_")}.jpg`,
            group: index,
            font: {size: 16},
        });
    });

    const networkMap = initMap(container, nodes);

    const slider = document.getElementById("similarity-slider");

    slider.oninput = function () {

        clearTimeout(sliderBounceBackTimeout);

        sliderBounceBackTimeout = setTimeout(() => {
            similarityThreshold = (Number(this.value) / 100);
            similarityDisplay.innerText = `>=${similarityThreshold * 100}%`;
            refreshEdges(networkMap);
        }, 400);
    };

    refreshEdges(networkMap);
}

function refreshEdges(networkMap) {

    console.log(`Refreshing edges (THRESHOLD: ${similarityThreshold})`);

    const products = [];
    const edgesForProducts = [];

    for (let i = 0; i < similarityMatrix.length; i += 2) {
        products.push(similarityMatrix[i]);
        edgesForProducts.push(similarityMatrix[i + 1]);
    }

    edges = [];

    networkMap.body.data.edges.clear();

    products.forEach((productLabel, productIndex) => {

        edgesForProducts[productIndex].forEach((similarity, edgeProductIndex) => {
            if (edgeProductIndex !== productIndex && similarity >= similarityThreshold) {
                if (edges.filter((e) => (e.from === edgeProductIndex && e.to === productIndex)
                    || (e.to === edgeProductIndex && e.from === productIndex)).length === 0) {

                    const newEdge = {
                        id: `${edgeProductIndex}-${productIndex}`,
                        from: edgeProductIndex,
                        to: productIndex,
                        value: similarity,
                        title: `${Math.floor(similarity * 100)}% Similarity`,
                    };
                    try {
                        networkMap.body.data.edges.add(newEdge);
                    } catch (e) {
                        // Ignore if already exists
                    }

                    edges.push(newEdge);
                }
            } else {
                // TODO: Remove edges?
            }
        });
    });

}

function initMap(container, nodes) {

    const data = {
        nodes,
        edges: []
    };
    const options = {
        nodes: {
            shape: "circularImage",
            shapeProperties: {
                borderDashes: false, // only for borders
                borderRadius: 24,     // only for box shape
                interpolation: false,  // only for image and circularImage shapes
                useImageSize: false,  // only for image and circularImage shapes
                useBorderWithImage: true // only for image shape
            },
            size: 64,
            chosen: true,
        },
        layout: {
            randomSeed: undefined,
            improvedLayout: true,
            hierarchical: {
                enabled: false,
                levelSeparation: 150,
                nodeSpacing: 400,
                treeSpacing: 300,
                blockShifting: false,
                parentCentralization: false,
                direction: 'DU',        // UD, DU, LR, RL
                sortMethod: 'hubsize'   // hubsize, directed
            },
        },
        physics: {
            forceAtlas2Based: {
                gravitationalConstant: -26,
                centralGravity: 0.005,
                springLength: 230,
                springConstant: 0.18
            },
            maxVelocity: 146,
            solver: "forceAtlas2Based",
            timestep: 0.35,
            stabilization: {iterations: 150}
        }
    };

    const network = new vis.Network(container, data, options);

    return network;
}